<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movimiento de Transacciones</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="custom-container">
        <h2>Movimiento de Transacciones</h2>
        <form onsubmit="event.preventDefault(); guardarTransaccion();">
            <!-- Número de Documento -->
            <div class="form-group">
                <label for="nro_docu">Número de Documento:</label>
                <input type="text" id="nro_docu" name="nro_docu" class="form-control" onblur="verificarDocumento()" required>
            </div>

            <!-- Tipo de Documento -->
            <div class="form-group">
                <label for="tipo_documento">Tipo de Documento:</label>
                <select id="tipo_documento" name="tipo_documento" class="form-control" required>
                    <option value="Factura">Factura</option>
                    <option value="Ajuste">Ajuste</option>
                    <option value="Documento interno">Documento interno</option>
                </select>
            </div>

            <!-- Cuenta Contable -->
            <div class="form-group">
                <label for="cuenta_contable">Cuenta Contable:</label>
                <input type="text" id="cuenta_contable" name="cuenta_contable" class="form-control" onblur="verificarCuentaContable()" required>
            </div>

            <!-- Monto de la Transacción -->
            <div class="form-group">
                <label for="monto_transaccion">Monto de la Transacción:</label>
                <input type="number" id="monto_transaccion" name="monto_transaccion" class="form-control" required>
            </div>

            <!-- Hecho por -->
            <div class="form-group">
                <label for="hecho_por">Hecho por:</label>
                <input type="text" id="hecho_por" name="hecho_por" class="form-control" value="Usuario" readonly>
            </div>

            <!-- Monto Débito -->
            <div class="form-group">
                <label for="monto_debito">Monto Débito:</label>
                <input type="number" id="monto_debito" name="monto_debito" class="form-control">
            </div>

            <!-- Monto Crédito -->
            <div class="form-group">
                <label for="monto_credito">Monto Crédito:</label>
                <input type="number" id="monto_credito" name="monto_credito" class="form-control">
            </div>

            <!-- Botones -->
            <button type="submit" class="btn btn-light btn-block">Guardar</button>
            <button type="button" class="btn btn-secondary btn-block">Cancelar</button>
        </form>
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Funciones JS (las mismas del código original)
        function verificarDocumento() {
            const nroDocu = document.getElementById('nro_docu').value;
            if (nroDocu !== '') {
                fetch('verificarDocumento.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'nro_docu=' + nroDocu
                })
                .then(response => response.json())
                .then(data => {
                    if (data.existe) {
                        if (data.actualizado) {
                            alert("Transacción ha sido Actualizada");
                        } else {
                            document.getElementById('tipo_documento').value = data.tipo_documento;
                            document.getElementById('cuenta_contable').value = data.cuenta_contable;
                            document.getElementById('monto_transaccion').value = data.monto_transaccion;
                        }
                    } else {
                        alert("No existe el número de documento, puede crear una nueva transacción.");
                    }
                });
            }
        }

        function verificarCuentaContable() {
            const cuentaContable = document.getElementById('cuenta_contable').value;
            fetch('verificarCuentaContable.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'cuenta_contable=' + cuentaContable
            })
            .then(response => response.json())
            .then(data => {
                if (!data.valida) {
                    alert("La cuenta contable no es válida o no es de tipo detalle.");
                }
            });
        }

        function validarSumaDebitosCreditos() {
            const debitos = parseFloat(document.getElementById('monto_debito').value) || 0;
            const creditos = parseFloat(document.getElementById('monto_credito').value) || 0;
            if (debitos !== creditos) {
                alert("La suma de los débitos debe ser igual a la suma de los créditos.");
                return false;
            }
            return true;
        }

        function guardarTransaccion() {
            if (validarSumaDebitosCreditos()) {
                const nroDocu = document.getElementById('nro_docu').value;
                const tipoDocumento = document.getElementById('tipo_documento').value;
                const cuentaContable = document.getElementById('cuenta_contable').value;
                const montoTransaccion = document.getElementById('monto_transaccion').value;
                const hechoPor = document.getElementById('hecho_por').value;
                const fechaDocu = new Date().toISOString().split('T')[0];
                fetch('guardarTransaccion.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `nro_docu=${nroDocu}&tipo_documento=${tipoDocumento}&cuenta_contable=${cuentaContable}&monto_transaccion=${montoTransaccion}&hecho_por=${hechoPor}&fecha_docu=${fechaDocu}`
                })
                .then(response => response.text())
                .then(data => {
                    alert(data);
                });
            }
        }
    </script>
</body>
</html>
